name: RISC-V Assembler Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential

    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
        profile: minimal
        components: rustfmt, clippy

    - name: Create library directory
      run: mkdir -p assembler-cpp/lib

    - name: Build Rust components
      run: |
        # First build the core isa library
        echo "Building core isa library..."
        cd isa
        cargo build --release --verbose
        cd ..
        
        # Then build the FFI library
        echo "Building FFI library..."
        cd isa-ffi
        cargo build --release --verbose
        
        # Copy the static library
        echo "Copying FFI library..."
        echo "Workspace root contents:"
        ls -la /home/runner/work/riscv-emu-ass/riscv-emu-ass/
        echo "Target release contents:"
        ls -la /home/runner/work/riscv-emu-ass/riscv-emu-ass/target/release/
        
        # Try to find the library file
        echo "Looking for FFI library files:"
        find /home/runner/work/riscv-emu-ass/riscv-emu-ass -name "libisa_ffi*"
        
        # Verify the target/release directory contents
        echo "Target release directory contents:"
        ls -la /home/runner/work/riscv-emu-ass/riscv-emu-ass/target/release/
        
        # Make sure we have the static library
        if [ ! -f /home/runner/work/riscv-emu-ass/riscv-emu-ass/target/release/libisa_ffi.a ]; then
            echo "ERROR: Static library libisa_ffi.a not found!"
            exit 1
        fi

    - name: Build and test C++ components
      run: |
        cd assembler-cpp
        # Ensure we have the static library
        echo "Verifying static library exists:"
        ls -la /home/runner/work/riscv-emu-ass/riscv-emu-ass/target/release/libisa_ffi.a
        
        # Build in build directory
        mkdir -p build
        cd build
        cmake .. -DRUST_FFI_PATH=/home/runner/work/riscv-emu-ass/riscv-emu-ass/target/release
        make VERBOSE=1 -j$(nproc)
        cd ..
        
        # Run the existing shell test runner (keeps previous checks)
        if [ -x tests/run_tests.sh ]; then
          chmod +x tests/run_tests.sh
          ./tests/run_tests.sh || true
        fi

        # Run the new golden test runner if it was built
        if [ -x build/test_golden ]; then
          echo "Running test_golden..."
          ./build/test_golden
        else
          echo "test_golden not found; skipping"
        fi

    - name: Upload test artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-outputs
        path: assembler-cpp/build/test_output/
        retention-days: 5  # Keep artifacts for 5 days